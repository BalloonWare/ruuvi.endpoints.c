
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ruuvi_endpoint_3.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;ruuvi_endpoint_3.h&quot;</a>
<a name="ln2">#include &quot;ruuvi_endpoints.h&quot;</a>
<a name="ln3">#include &lt;stddef.h&gt;</a>
<a name="ln4">#include &lt;stdbool.h&gt;</a>
<a name="ln5">#include &lt;math.h&gt;</a>
<a name="ln6"> </a>
<a name="ln7">static void ruuvi_endpoint_3_encode_acceleration (uint8_t * const buffer,</a>
<a name="ln8">        const float acceleration, const float invalid)</a>
<a name="ln9">{</a>
<a name="ln10">    if (invalid != acceleration)</a>
<a name="ln11">    {</a>
<a name="ln12">        int16_t decimal = (int16_t) (acceleration * 1000);</a>
<a name="ln13">        buffer[0] = decimal &gt;&gt; 8;</a>
<a name="ln14">        buffer[1] = decimal &amp; 0xFF;</a>
<a name="ln15">    }</a>
<a name="ln16">    else</a>
<a name="ln17">    {</a>
<a name="ln18">        buffer[0] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln19">        buffer[1] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln20">    }</a>
<a name="ln21">}</a>
<a name="ln22"> </a>
<a name="ln23">ruuvi_endpoint_status_t ruuvi_endpoint_3_encode (uint8_t * const buffer,</a>
<a name="ln24">        const ruuvi_endpoint_3_data_t * const data, const float invalid)</a>
<a name="ln25">{</a>
<a name="ln26">    if (NULL == buffer  || NULL == data) { return RUUVI_ENDPOINT_ERROR_NULL; }</a>
<a name="ln27"> </a>
<a name="ln28">    buffer[RUUVI_ENDPOINT_3_OFFSET_HEADER] = RUUVI_ENDPOINT_3_DESTINATION;</a>
<a name="ln29"> </a>
<a name="ln30">    // HUMIDITY</a>
<a name="ln31">    if (invalid != data-&gt;humidity_rh)</a>
<a name="ln32">    {</a>
<a name="ln33">        //Humidity (one lsb is 0.5%, e.g. 128 is 64%). Round the value</a>
<a name="ln34">        buffer[RUUVI_ENDPOINT_3_OFFSET_HUMIDITY] = (uint8_t) ( (data-&gt;humidity_rh * 2) + 0.5);</a>
<a name="ln35">    }</a>
<a name="ln36">    else</a>
<a name="ln37">    {</a>
<a name="ln38">        buffer[RUUVI_ENDPOINT_3_OFFSET_HUMIDITY] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln39">    }</a>
<a name="ln40"> </a>
<a name="ln41">    // Temperature</a>
<a name="ln42">    if (invalid != data-&gt;temperature_c)</a>
<a name="ln43">    {</a>
<a name="ln44">        //Temperature (MSB is sign, next 7 bits are decimal value)</a>
<a name="ln45">        float temperature = data-&gt;temperature_c;</a>
<a name="ln46">        bool sign = (temperature &lt; 0) ? 1 : 0;</a>
<a name="ln47"> </a>
<a name="ln48">        // abs value</a>
<a name="ln49">        if (0 &gt; temperature) { temperature = 0 - temperature; }</a>
<a name="ln50"> </a>
<a name="ln51">        // cap the temperature</a>
<a name="ln52">        if (127 &lt; temperature) {temperature = 127; }</a>
<a name="ln53"> </a>
<a name="ln54">        buffer[RUUVI_ENDPOINT_3_OFFSET_TEMPERATURE_DECIMAL] = (uint8_t) temperature | (sign &lt;&lt; 7);</a>
<a name="ln55">        uint8_t temperature_fraction = (uint8_t) ( (temperature - floor (temperature)) * 100);</a>
<a name="ln56">        buffer[RUUVI_ENDPOINT_3_OFFSET_TEMPERATURE_FRACTION] = temperature_fraction;</a>
<a name="ln57">    }</a>
<a name="ln58">    else</a>
<a name="ln59">    {</a>
<a name="ln60">        buffer[RUUVI_ENDPOINT_3_OFFSET_TEMPERATURE_DECIMAL]  = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln61">        buffer[RUUVI_ENDPOINT_3_OFFSET_TEMPERATURE_FRACTION] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln62">    }</a>
<a name="ln63"> </a>
<a name="ln64">    // Pressure</a>
<a name="ln65">    if (invalid != data-&gt;pressure_pa)</a>
<a name="ln66">    {</a>
<a name="ln67">        uint32_t pressure = data-&gt;pressure_pa;</a>
<a name="ln68">        pressure -= 50000;</a>
<a name="ln69">        buffer[RUUVI_ENDPOINT_3_OFFSET_PRESSURE_MSB] = pressure &gt;&gt; 8;</a>
<a name="ln70">        buffer[RUUVI_ENDPOINT_3_OFFSET_PRESSURE_LSB] = pressure &amp; 0xFF;</a>
<a name="ln71">    }</a>
<a name="ln72">    else</a>
<a name="ln73">    {</a>
<a name="ln74">        buffer[RUUVI_ENDPOINT_3_OFFSET_PRESSURE_MSB] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln75">        buffer[RUUVI_ENDPOINT_3_OFFSET_PRESSURE_LSB] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln76">    }</a>
<a name="ln77"> </a>
<a name="ln78">    // acceleration</a>
<a name="ln79">    ruuvi_endpoint_3_encode_acceleration (&amp;buffer[RUUVI_ENDPOINT_3_OFFSET_ACCELERATIONX_MSB],</a>
<a name="ln80">                                          data-&gt;accelerationx_g, invalid);</a>
<a name="ln81">    ruuvi_endpoint_3_encode_acceleration (&amp;buffer[RUUVI_ENDPOINT_3_OFFSET_ACCELERATIONY_MSB],</a>
<a name="ln82">                                          data-&gt;accelerationy_g, invalid);</a>
<a name="ln83">    ruuvi_endpoint_3_encode_acceleration (&amp;buffer[RUUVI_ENDPOINT_3_OFFSET_ACCELERATIONZ_MSB],</a>
<a name="ln84">                                          data-&gt;accelerationz_g, invalid);</a>
<a name="ln85"> </a>
<a name="ln86">    // voltage</a>
<a name="ln87">    if (invalid != data-&gt;battery_v)</a>
<a name="ln88">    {</a>
<a name="ln89">        uint32_t voltage = (data-&gt;battery_v * 1000 &gt; 0) ? data-&gt;battery_v * 1000 : 0;</a>
<a name="ln90">        buffer[RUUVI_ENDPOINT_3_OFFSET_VOLTAGE_MSB] = voltage &gt;&gt; 8;</a>
<a name="ln91">        buffer[RUUVI_ENDPOINT_3_OFFSET_VOLTAGE_LSB] = voltage &amp; 0xFF;</a>
<a name="ln92">    }</a>
<a name="ln93">    else</a>
<a name="ln94">    {</a>
<a name="ln95">        buffer[RUUVI_ENDPOINT_3_OFFSET_VOLTAGE_MSB] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln96">        buffer[RUUVI_ENDPOINT_3_OFFSET_VOLTAGE_LSB] = RUUVI_ENDPOINT_3_INVALID_DATA;</a>
<a name="ln97">    }</a>
<a name="ln98"> </a>
<a name="ln99">    return RUUVI_ENDPOINT_SUCCESS;</a>
<a name="ln100">}</a>

</code></pre>
<div class="balloon" rel="10"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v550/" target="_blank">V550</a> An odd precise comparison: invalid != acceleration. It's probably better to use a comparison with defined precision: fabs(A - B) > Epsilon.</p></div>
<div class="balloon" rel="12"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '*' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="12"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2003/" target="_blank">V2003</a> Explicit conversion from 'float' type to signed integer type: (int16_t)(acceleration * 1000)</p></div>
<div class="balloon" rel="13"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand 'decimal' of the '>>' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="13"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'decimal >> 8' expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="13"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="14"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left and right operands of the '&' operator should not have essential 'signed' and 'signed' types respectively. Consider inspecting operands: left - 'decimal', right - '0xFF'</p></div>
<div class="balloon" rel="14"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'decimal & 0xFF' expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="14"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="18"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="19"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="26"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '1' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="28"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="31"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v550/" target="_blank">V550</a> An odd precise comparison: invalid != data->humidity_rh. It's probably better to use a comparison with defined precision: fabs(A - B) > Epsilon.</p></div>
<div class="balloon" rel="34"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '*' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="34"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2004/" target="_blank">V2004</a> Explicit conversion from 'double' type to unsigned integer type: (uint8_t)((data->humidity_rh * 2) + 0.5)</p></div>
<div class="balloon" rel="38"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="42"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v550/" target="_blank">V550</a> An odd precise comparison: invalid != data->temperature_c. It's probably better to use a comparison with defined precision: fabs(A - B) > Epsilon.</p></div>
<div class="balloon" rel="46"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="46"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(temperature < 0) ? 1 : 0' expression should not be converted from the essential 'signed' type to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="49"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '>' operator should have the same essential type. The current types are: 'signed' and 'floating'.</p></div>
<div class="balloon" rel="49"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'signed' and 'floating'.</p></div>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'signed' and 'floating'.</p></div>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '127' expression should not be converted from the essential 'signed' type to the essential 'floating' type.</p></div>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="54"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2004/" target="_blank">V2004</a> Explicit conversion from 'float' type to unsigned integer type: (uint8_t) temperature</p></div>
<div class="balloon" rel="54"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand 'sign' of the '<<' operator should not have the essential 'Boolean' type.</p></div>
<div class="balloon" rel="54"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '|' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="54"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The right operand '(sign << 7)' of the '|' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="54"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(uint8_t) temperature | (sign << 7)' expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="54"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="55"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '*' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="55"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2004/" target="_blank">V2004</a> Explicit conversion from 'double' type to unsigned integer type.</p></div>
<div class="balloon" rel="60"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="61"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="65"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v550/" target="_blank">V550</a> An odd precise comparison: invalid != data->pressure_pa. It's probably better to use a comparison with defined precision: fabs(A - B) > Epsilon.</p></div>
<div class="balloon" rel="67"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'data->pressure_pa' expression should not be converted from the essential 'floating' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="68"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '-=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="69"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'pressure >> 8' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '&' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The right operand '0xFF' of the '&' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'pressure & 0xFF' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="74"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="75"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="87"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v550/" target="_blank">V550</a> An odd precise comparison: invalid != data->battery_v. It's probably better to use a comparison with defined precision: fabs(A - B) > Epsilon.</p></div>
<div class="balloon" rel="89"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '*' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="89"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '>' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="89"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '?:' operator should have the same essential type. The current types are: 'floating' and 'signed'.</p></div>
<div class="balloon" rel="89"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'floating' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="90"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'voltage >> 8' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '&' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The right operand '0xFF' of the '&' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'voltage & 0xFF' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="95"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="96"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="23"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2506/" target="_blank">V2506</a> A function should have a single point of exit at the end.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
